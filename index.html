<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ratatimba</title>
    <style>
        .row {
            display: flex;
            gap: 1rem;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        label {
            font-size: 2rem;
            margin-bottom: 0.3rem;
        }
        input[type="number"], input[type="text"] {
            width: 60px;
            padding: 0.3rem;
            font-size: 1rem;
            text-align: center;
        }
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .player-row {
            margin-top: 2rem;
            stroke: black;
        }
        body {
            background: #181818;
            color: #e0e0e0;
            font-family: 'Share Tech Mono', 'Consolas', monospace;
        }

        .row, .player-row {
            background: #232323;
            border: 2px solid #444;
            border-radius: 8px;
            box-shadow: 0 2px 8px #000a;
            padding: 1rem 2rem;
        }

        .input-group label {
            color: #00ff41;
            text-shadow: 0 0 4px #00ff41, 0 0 8px #00ff4188;
        }

        input[type="number"], input[type="text"] {
            background: #111;
            color: #00ff41;
            border: 1px solid #00ff41;
            border-radius: 4px;
            box-shadow: 0 0 4px #00ff4144;
        }

        button {
            background: linear-gradient(90deg, #00ff41 0%, #008f11 100%);
            color: #181818;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            font-family: inherit;
            padding: 0.5rem 1.2rem;
            margin-left: 0.5rem;
            box-shadow: 0 0 8px #00ff4144;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover {
            background: linear-gradient(90deg, #008f11 0%, #00ff41 100%);
            color: #fff;
        }

        input.minitext {
            width: 40px;
            font-size: 0.6rem;
            margin-top: 0.2rem;
            background: #222;
            color: #aaa;
            border: 1px solid #555;
            box-shadow: none;
        }

        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        @media (max-width: 600px) {
            .row, .player-row {
                flex-direction: column;
                align-items: stretch;
                padding: 1rem 0.5rem;
                gap: 0.8rem;
            }
            .input-group label {
                font-size: 1.5rem;
            }
            input[type="number"], input[type="text"] {
                width: 100%;
                font-size: 1rem;
                min-width: 0;
            }
            button {
                width: 100%;
                margin-left: 0;
                margin-top: 0.5rem;
                font-size: 1rem;
                padding: 0.7rem 0;
            }
            body {
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="row">
        <div style="display: flex; flex-direction: column; align-items: center; margin-right: 1rem;">
            <div class="input-group" style="flex-direction: row;">
                <label style="margin-right: 5px; width: 44px; justify-content: center;">‚ô†Ô∏è</label>
                <input type="text" class="CardSlot" id="CardsSpades" style="width: 50dvw;">
                <Button class="RefreshPrice" id="Spades">üîÑ(<span class="NewPrice">100</span>)</Button>
            </div>
            <div class="input-group" style="flex-direction: row;">
                <label style="margin-right: 5px; width: 44px; justify-content: center;">‚ô•Ô∏è</label>
                <input type="text" class="CardSlot" id="CardsHearts" style="width: 50dvw;">
                <Button class="RefreshPrice" id="Hearts">üîÑ(<span class="NewPrice">100</span>)</Button>
            </div>
            <div class="input-group" style="flex-direction: row;">
                <label style="margin-right: 5px; width: 44px; justify-content: center;">‚ô¶Ô∏è</label>
                <input type="text" class="CardSlot" id="CardsDiamonds" style="width: 50dvw;">
                <Button class="RefreshPrice" id="Diamonds">üîÑ(<span class="NewPrice">100</span>)</Button>
            </div>
            <div class="input-group" style="flex-direction: row;">
                <label style="margin-right: 5px; width: 44px; justify-content: center;">‚ô£Ô∏è</label>
                <input type="text" class="CardSlot" id="CardsClubs" style="width: 50dvw;">
                <Button class="RefreshPrice" id="Clubs">üîÑ(<span class="NewPrice">100</span>)</Button>
            </div>
        </div>
    </div>
    <div class="row">
        <div style="display: flex; flex-direction: column; align-items: center; margin-right: 1rem;">
            <button onclick="BuyAll()" id="BuyAll" style="margin-bottom: 3px;">Buy All</button>
            <button onclick="SellAll()" id="SellAll">Sell All</button>
        </div>
        <div class="input-group">
            <label>‚ô†Ô∏è</label>
            <input type="number" id="PriceSpades" value="100">
        </div>
        <div class="input-group">
            <label>‚ô•Ô∏è</label>
            <input type="number" id="PriceHearts" value="100">
        </div>
        <div class="input-group">
            <label>‚ô¶Ô∏è</label>
            <input type="number" id="PriceDiamonds" value="100">
        </div>
        <div class="input-group">
            <label>‚ô£Ô∏è</label>
            <input type="number" id="PriceClubs" value="100">
        </div>
        <button id="addPlayer">Add player</button>
    <script>
        function BuyAll(){
            const players = document.querySelectorAll('.player-row');
            players.forEach(player => {
                let PlayerID = player.id;
                let Spades = player.querySelector('.Spades input').value;
                let Hearts = player.querySelector('.Hearts input').value;
                let Diamonds = player.querySelector('.Diamonds input').value;
                let Clubs = player.querySelector('.Clubs input').value;
                let amounts = {
                    "Spades": Spades,
                    "Hearts": Hearts,
                    "Diamonds": Diamonds,
                    "Clubs": Clubs
                };
                Buy(amounts,PlayerID);
                player.querySelector('.Spades input').value = 0;
                player.querySelector('.Hearts input').value = 0;
                player.querySelector('.Diamonds input').value = 0;
                player.querySelector('.Clubs input').value = 0;
            });
        }

        function SellAll(){
            const players = document.querySelectorAll('.player-row');
            players.forEach(player => {
                let PlayerID = player.id;
                let Spades = player.querySelector('.Spades input').value;
                let Hearts = player.querySelector('.Hearts input').value;
                let Diamonds = player.querySelector('.Diamonds input').value;
                let Clubs = player.querySelector('.Clubs input').value;
                let amounts = {
                    "Spades": Spades,
                    "Hearts": Hearts,
                    "Diamonds": Diamonds,
                    "Clubs": Clubs
                };
                Sell(amounts,PlayerID);
                player.querySelector('.Spades input').value = 0;
                player.querySelector('.Hearts input').value = 0;
                player.querySelector('.Diamonds input').value = 0;
                player.querySelector('.Clubs input').value = 0;
            });
        }

        function Buy(amounts,player){
            for (const suit in amounts){
                let price = document.getElementById('Price' + suit).value;
                let totalCost = amounts[suit] * price;
                let playerMoney = document.querySelector('#' + player + ' .playerMoney input').value;
                playerMoney = parseInt(playerMoney);
                totalCost = parseInt(totalCost);
                document.querySelector('#' + player + ' .playerMoney input').value = playerMoney - totalCost;
                document.querySelector('#' + player + ' .' + suit + ' input.minitext').value = parseInt(document.querySelector('#' + player + ' .' + suit + ' input.minitext').value) + parseInt(amounts[suit]);
            }
        }

        function Sell(amounts,player){
            for (const suit in amounts){
                let price = document.getElementById('Price' + suit).value;
                let totalCost = amounts[suit] * price;
                let playerMoney = document.querySelector('#' + player + ' .playerMoney input').value;
                playerMoney = parseInt(playerMoney);
                totalCost = parseInt(totalCost);
                document.querySelector('#' + player + ' .playerMoney input').value = playerMoney + totalCost;
                document.querySelector('#' + player + ' .' + suit + ' input.minitext').value = parseInt(document.querySelector('#' + player + ' .' + suit + ' input.minitext').value) - parseInt(amounts[suit]);
            }
        }
 function addPlayer() {
            const playerCount = document.querySelectorAll('.player-row').length + 1;
            const newPlayerRow = document.createElement('div');
            newPlayerRow.className = 'row player-row';
            newPlayerRow.id = `player${playerCount}`;
            newPlayerRow.innerHTML = `
                <input type="text" placeholder="Player ${playerCount}" id="player${playerCount}Name">
                <div class="input-group playerMoney">
                    <label>üí∏</label>
                    <input type="number" value="1000">
                </div>
                <div class="input-group Spades">
                    <label>‚ô†Ô∏è</label>
                    <input type="number" value="0">
                    <input disabled type="number" id="player${playerCount}Spades" value="0" class="minitext suit">
                </div>
                <div class="input-group Hearts">
                    <label>‚ô•Ô∏è</label>
                    <input type="number" value="0">
                    <input disabled type="number" id="player${playerCount}Hearts" value="0" class="minitext suit">
                </div>
                <div class="input-group Diamonds">
                    <label>‚ô¶Ô∏è</label>
                    <input type="number" value="0">
                    <input disabled type="number" id="player${playerCount}Diamonds" value="0" class="minitext suit">
                </div>
                <div class="input-group Clubs">
                    <label>‚ô£Ô∏è</label>
                    <input type="number" value="0">
                    <input disabled type="number" id="player${playerCount}Clubs" value="0" class="minitext suit">
                </div>
                <button id="Buy" >Buy</button>
                <button id="Sell">Sell</button>
            `;
            document.body.appendChild(newPlayerRow);
            newPlayerRow.querySelector('#Buy').addEventListener('click', function() {
                let PlayerID = this.parentElement.id;
                let Spades = this.parentElement.querySelector('.Spades input').value;
                let Hearts = this.parentElement.querySelector('.Hearts input').value;
                let Diamonds = this.parentElement.querySelector('.Diamonds input').value;
                let Clubs = this.parentElement.querySelector('.Clubs input').value;
                let amounts = {
                    "Spades": Spades,
                    "Hearts": Hearts,
                    "Diamonds": Diamonds,
                    "Clubs": Clubs
                };
                Buy(amounts,PlayerID);
                this.parentElement.querySelector('.Spades input').value = 0;
                this.parentElement.querySelector('.Hearts input').value = 0;
                this.parentElement.querySelector('.Diamonds input').value = 0;
                this.parentElement.querySelector('.Clubs input').value = 0;
            })
            newPlayerRow.querySelector('#Sell').addEventListener('click', function() {
                let PlayerID = this.parentElement.id;
                let Spades = this.parentElement.querySelector('.Spades input').value;
                let Hearts = this.parentElement.querySelector('.Hearts input').value;
                let Diamonds = this.parentElement.querySelector('.Diamonds input').value;
                let Clubs = this.parentElement.querySelector('.Clubs input').value;
                let amounts = {
                    "Spades": Spades,
                    "Hearts": Hearts,
                    "Diamonds": Diamonds,
                    "Clubs": Clubs
                };
               Sell(amounts,PlayerID); 
                this.parentElement.querySelector('.Spades input').value = 0;
                this.parentElement.querySelector('.Hearts input').value = 0;
                this.parentElement.querySelector('.Diamonds input').value = 0;
                this.parentElement.querySelector('.Clubs input').value = 0;
            });
        }
        document.getElementById('addPlayer').addEventListener('click', addPlayer);
        document.querySelectorAll('.RefreshPrice').forEach(button => {
            button.addEventListener('click', function() {
                let suit = this.id;
                let NewPrice = this.querySelector('.NewPrice');
                let ToChange = "Price" + suit;
                if(NewPrice.textContent != "X"){
                    document.querySelector('#' + ToChange).value = NewPrice.textContent;
                }
            });
        });
        document.querySelectorAll('.CardSlot').forEach(input => {
            input.addEventListener('change', function() {
                let suit = this.id.replace('Cards','');
                let cards = this.value;
                CalculatePrice(suit,cards);
            });
        });
        window.onload = function() {
            for(let i = 0; i < 4; i++){
                addPlayer();
            }
        };


        let CardValues = {
            "X": 0,
            "K": 10,
            "Q": 10,
            "J": 15,
            "T": 10,
            "9": 9,
            "8": 8,
            "7": 7,
            "6": 6,
            "5": 5,
            "4": 4,
            "3": 3,
            "2": 2,
            "A": 1
        };

        let JokersSeen = {
            0: 0,
            1: 20,
            2: -40,
            3: 60,
            4: -80,
            5: 100,
            6: -120,
            7: 140
        }

        function CalculateKing(Kingsuit,letter,cardArray){
            priceChange = 0
            let mult
            if(Kingsuit == letter){
                mult = 1
            }else{
                mult = -1
            }
            for(i=0;i<cardArray.length;i++){
                let card = cardArray[i]
                let suitChar = card[0].toUpperCase()
                if(suitChar != Kingsuit){
                    continue
                }else{
                    let value = card[1].toUpperCase()
                    if(value == "K"){
                        continue
                    }else{
                        let currentCardChange = CardValues[value]
                        if(value == "Q" && ((i == 0) || (i == cardArray.length - 1))){
                            currentCardChange += 5
                        }
                        if(currentCardChange < 3){
                            if(mult == 1){
                                currentCardChange += 10
                            }
                        }
                        priceChange += currentCardChange * mult
                    }
                }
            }
            return priceChange
        }

        function CalculatePrice(suit,cards){
            let basePrice = document.getElementById('Price' + suit).value;
            let cardArray = cards.split(',').map(card => card.trim()).filter(card => card !== "");
            let letter = suit[0]
            let changePrice = 0;
            console.log(cardArray, letter);
            if(cardArray == []){
                document.getElementById(suit).querySelector('.NewPrice').textContent = basePrice;
            }else{
                let LastSeen = ""
                let Combo = {
                    "positive": 0,
                    "negative": 0
                }
                let err = false
                let jokerCount = 0
                let KingsSeen = {
                    "S": false,
                    "H": false,
                    "D": false,
                    "C": false
                }
                for(let i = 0; i < cardArray.length; i++){
                    let card = cardArray[i]
                    let value = card[1]
                    let ExtraMults = card.slice(2).length
                    let suitChar = card[0]
                    let mult = 1
                    if(!(value && suitChar)){
                        err = true
                        break
                    }
                    value = value.toUpperCase()
                    suitChar = suitChar.toUpperCase()
                    if((!CardValues[value]) && (value != "X")){
                        err = true
                        break
                    }
                    if((suitChar == letter) || (suitChar == "X")){
                        Combo["positive"] += 1
                        Combo["negative"] = 0
                        mult = 1
                        if(Combo["positive"] >= 4){
                            mult = 2
                            if(Combo["positive"] == 4){
                                changePrice += 20
                            }
                            if(Combo["positive"] >= 6){
                                if(Combo["positive"] == 6){
                                    changePrice -= 50
                                }
                                mult = -2
                            }
                        }
                    }else{
                        Combo["positive"] = 0
                        if(suitChar == LastSeen){
                            Combo["negative"] += 1
                        }else{
                            Combo["negative"] = 1
                        }
                        mult = -1
                        if(Combo["negative"] >= 3){
                            if(Combo["negative"] == 3){
                                changePrice -= 20
                            }
                            mult = -2
                            if(Combo["negative"] >= 5){
                                if(Combo["negative"] == 5){
                                    changePrice += 50
                                }
                                mult = 3
                            }
                        }
                    }
                    if(suitChar != "X"){
                        LastSeen = suitChar
                    }
                    if(value == "X"){
                        jokerCount += 1
                    }
                    if(value == "K"){
                        KingsSeen[suitChar] = true
                    }
                    let currentCardChange = CardValues[value]
                    if(value == "Q" && ((i == 0) || (i == cardArray.length - 1))){
                        currentCardChange += 5
                    }
                    if(value == "Q"){
                        if(i != 0){
                            let prevCard = cardArray[i - 1]
                            let prevSuitChar = prevCard[0].toUpperCase()
                            let prevCardValue = prevCard[1].toUpperCase()
                            let prevCardChange = CardValues[prevCardValue]
                            if((prevCardChange < 3) && (prevSuitChar == letter)){
                                    prevCardChange += 10
                                }
                            if(prevSuitChar == suitChar){
                                currentCardChange += prevCardChange 
                            }else{
                                if(prevSuitChar == letter){
                                    currentCardChange -= prevCardChange
                                }else{
                                    if(suitChar == letter){
                                        currentCardChange -= prevCardChange
                                    }else{
                                    currentCardChange += prevCardChange
                                    }
                                }
                            }
                        }
                        if(i != cardArray.length - 1){
                            let nextCard = cardArray[i + 1]
                            let nextSuitChar = nextCard[0].toUpperCase()
                            let nextCardValue = nextCard[1].toUpperCase()
                            let nextCardChange = CardValues[nextCardValue]
                            if((nextCardChange < 3) && (nextSuitChar == letter)){
                                    nextCardChange += 10
                                }
                            if(nextSuitChar == suitChar){
                                currentCardChange += nextCardChange 
                            }else{
                                if(nextSuitChar == letter){
                                    currentCardChange -= nextCardChange
                                }else{
                                    if(suitChar == letter){
                                        currentCardChange -= nextCardChange
                                    }else{
                                    currentCardChange += nextCardChange
                                    }
                                }
                            }
                        }
                    }
                    if(currentCardChange < 3){
                        if(suitChar == letter){
                            currentCardChange += 10
                        }
                    }
                    if(ExtraMults > 0){
                        if(mult > 0){
                            mult += ExtraMults
                        }else{
                            mult -= ExtraMults
                        }
                    }
                    changePrice += currentCardChange * mult
                }
                changePrice += JokersSeen[jokerCount]
                for(const k in KingsSeen){
                    if(KingsSeen[k]){
                        let currentKingChange = CalculateKing(k,letter,cardArray)
                        changePrice += currentKingChange
                    }
                }
                if(err){
                    document.getElementById(suit).querySelector('.NewPrice').textContent = "X";
                }else{
                    let finalPrice = parseInt(basePrice) + parseInt(changePrice);
                    if(finalPrice < 0){
                        finalPrice = 0
                    }
                    document.getElementById(suit).querySelector('.NewPrice').textContent = finalPrice;
                }
            }
        }
    </script>
</body>
</html>